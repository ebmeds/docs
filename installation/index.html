<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="shortcut icon" href="../img/favicon.ico">

    <title>Installation - EBMeDS 2.0</title>

    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/highlight.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="..">EBMeDS 2.0</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Installation <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../system-requirements/">System requirements</a>
</li>

                        
                            
<li >
    <a href="../components/">Components</a>
</li>

                        
                            
<li class="active">
    <a href="./">Installation</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">FHIR <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../api/fhir/getting-started/">Getting started</a>
</li>

                        
                            
<li >
    <a href="../api/fhir/cds-hooks/">CDS hooks</a>
</li>

                        
                            
<li >
    <a href="../api/fhir/hook-catalog/">Hook catalog</a>
</li>

                        
                            
<li >
    <a href="../api/fhir/custom-rest/">Custom REST</a>
</li>

                        
                            
<li >
    <a href="../api/fhir/resources/">Resources</a>
</li>

                        
                            
<li >
    <a href="../api/fhir/code-systems/">Code Systems</a>
</li>

                        
                            
<li >
    <a href="../api/fhir/extensions/">Extensions</a>
</li>

                        
                            
<li >
    <a href="../api/fhir/oda/">ODA-specific information</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../security/">Security & Error handling</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fa fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../components/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../api/fhir/getting-started/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#installation">Installation</a></li>
            <li class="second-level"><a href="#install-prerequisites">Install prerequisites</a></li>
                
                <li class="third-level"><a href="#install-docker">Install Docker</a></li>
                <li class="third-level"><a href="#download-ebmeds-docker-repository">Download ebmeds-docker repository</a></li>
            <li class="second-level"><a href="#configure-the-services">Configure the services</a></li>
                
            <li class="second-level"><a href="#get-a-docker-registry-username-from-duodecim">Get a Docker registry username from Duodecim</a></li>
                
                <li class="third-level"><a href="#start-the-services">Start the services</a></li>
                <li class="third-level"><a href="#file-system-access">File system access</a></li>
                <li class="third-level"><a href="#advanced-deployment">Advanced deployment</a></li>
            <li class="second-level"><a href="#verifying-the-installation">Verifying the installation</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="installation">Installation</h1>
<p>The main steps to installing a minimal working deployment of EBMEDS are the following:</p>
<ul>
<li>Install prerequisites</li>
<li>Get a Docker registry username from Duodecim</li>
<li>Configure the service</li>
<li>Start up the service</li>
</ul>
<p>These steps are given in more detail below.</p>
<h2 id="install-prerequisites">Install prerequisites</h2>
<p>EBMEDS only requires Docker to run. Docker runs on Linux, Windows and Mac, but Linux is recommended, since Docker runs Linux internally and thus running it on other platforms incurs a small performance hit. Note that Docker supports running Windows internally on newer versions of Windows Server, but this is not supported by EBMEDS.</p>
<p>It is also recommended to have <code>git</code> available on the server, for downloading the deployment package and keeping track of your local changes.</p>
<h3 id="install-docker">Install Docker</h3>
<p>The installation instructions for Docker itself can be found on e.g. <a href="https://www.docker.com">Docker's site</a>. We support version 1.13 or newer, and recommend the latest stable version. We warmly recommend to get well acquainted with Docker, many of the configuration steps below are more Docker specific than EBMEDS specific.</p>
<h3 id="download-ebmeds-docker-repository">Download ebmeds-docker repository</h3>
<p>Duodecim provides the <code>ebmeds-docker</code> package, which is freely available and contains a pre-configured setup for a minimal installation of EBMEDS. Minimal in this case means a single-server setup for basic usage. The setup includes</p>
<ul>
<li>Four running copies of the EBMEDS analytical engine</li>
<li>The services Logstash and Elasticsearch for storing log messages and (optionally) entire request bodies</li>
<li>The Kibana service for inspecting the above data</li>
<li>Redis for storing user configuration and for caching optimizations</li>
</ul>
<p>The package is downloaded by running the command</p>
<pre><code class="bash"># Get a copy of the EBMEDS Docker configuration
git clone https://github.com/ebmeds/ebmeds-docker.git

# We will be working from this directory for the rest of this installation guide
cd ebmeds-docker
</code></pre>

<p>This repository does <em>not</em> contain the Docker images themselves, only startup scripts and configuration files. It also contains a sample <code>docker-compose.yml</code> file to get a Docker Swarm up and running with minimal effort. This file can be used as inspiration for more advanced setups.</p>
<h2 id="configure-the-services">Configure the services</h2>
<p>EBMEDS consists of a number of services:</p>
<ul>
<li>api-gateway</li>
<li>format-converter</li>
<li>engine</li>
<li>clinical-datastore</li>
<li>elastichsearch <em>(third-party software)</em></li>
<li>kibana <em>(third-party software)</em></li>
<li>logstash <em>(third-party software)</em></li>
<li>redis <em>(third-party software)</em></li>
</ul>
<p>These services are pre-configured to work together, however some settings need to be decided upon by the system administrator. The settings can be found in <code>config.env</code>:</p>
<ul>
<li><code>LOG_LEVEL</code> may be handy to set to <code>debug</code> while setting up. Return it to <code>info</code> or <code>warn</code> for production</li>
<li><code>ES_JAVA_OPTS</code> are options for Elasticsearch, follow the instructions in the comments</li>
<li><code>LS_JAVA_OPTS</code> are options for Logstash, follow the instructions in the comments</li>
<li><code>xpack.*</code> advanced, paid for features of Elasticsearch that are not part of the standard package. Consult the Elastic Stack documentation to see if it is something you need.</li>
</ul>
<h2 id="get-a-docker-registry-username-from-duodecim">Get a Docker registry username from Duodecim</h2>
<p>If you don't already have it, you need a Duodecim-supplied username and password to be able to download the EBMEDS Docker images, which reside in a private repository at <code>quay.io</code>. The username is in the form <code>duodecim+yourname</code>.</p>
<h3 id="start-the-services">Start the services</h3>
<p>EBMEDS' Docker images are stored in a repository on quay.io. Vendor organizations are provided with a login username and password. The credentials are asked on each run of the <code>start.sh</code> command, which quickly gets cumbersome. Instead, the credentials can be passed as environment variables <code>DOCKER_LOGIN</code> and <code>DOCKER_PASSWORD</code>, like so:</p>
<pre><code class="bash">DOCKER_LOGIN=duodecim+example DOCKER_PASSWORD=example sudo -E sh start.sh
</code></pre>

<h3 id="file-system-access">File system access</h3>
<p>Docker containers cannot per default persist data to disk, i.e. all changes to the container file system are lost when a container is shut down. Therefore, Docker must be explicitly told when it is allowed to change the filesystem on the server. This is done by mounting so-called <em>volumes</em> into the containers. Changes to the files inside the containers are then reflected on the filesystem of the server itself. The volumes are usually physically located in <code>/var/lib/docker/volumes</code>, but this varies from system to system. In any case, wherever these volumes are kept, sufficient disk space should be reserved.</p>
<aside class="notice">
Also note that the Docker daemon itself will store pulled images internally. These images are not removed by default when new versions are pulled, to support roll-backs of updates that are not working etc. The system administrator should keep in mind that the images will, in time, take up a lot of disk space, and steps should be taken to remove unused Docker images. These are also kept in **/var/lib/docker**
</aside>

<h3 id="advanced-deployment">Advanced deployment</h3>
<p>There are many advanced features of Docker that can be used to make the service more failsafe. This includes backups, monitoring, automatic node failure recovery etc. These advanced features should be implemented by a competent DevOps professional and is not covered in this documentation.</p>
<h2 id="verifying-the-installation">Verifying the installation</h2>
<p>To see that the installation is succesful, perform the checklist below. $HOST is the hostname of the server running the Swarm. It may also be localhost:</p>
<ul>
<li>Make a HTTP GET to $HOST:3001/status, you should receive the reply "OK".</li>
<li>Make a HTTP POST to $HOST:3001/xml, with the payload of an EBMEDS XML request. You should receive an XML response.</li>
<li>Open up Kibana at $HOST:5601 and add the index <code>ebmeds-logs</code>, if not already added.</li>
<li>In the "Discover" tab, check the <code>ebmeds-logs</code> index to see that logging from the various containers is working.</li>
<li>Use the command <code>docker ps -a</code> (<code>sudo</code> may be required) to check that all the services stay up for more than a couple of minutes. If not, there may be a file permission problem or you are running out of memory. <code>docker logs</code> should give you more clues.</li>
</ul></div>
        
    </div>

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
    </footer>

    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '..';
    </script>
    <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
    <script src="../js/base.js"></script>
    <script src="../search/require.js"></script>
    <script src="../search/search.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
