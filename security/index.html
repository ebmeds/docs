<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="shortcut icon" href="../img/favicon.ico">

    <title>Security & Error handling - EBMEDS 2.0</title>

    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/highlight.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="">EBMEDS 2.0</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Installation <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="system-requirements/">System requirements</a>
</li>

                        
                            
<li >
    <a href="components/">Components</a>
</li>

                        
                            
<li >
    <a href="installation/">Installation</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">FHIR <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="api/fhir/getting-started/">Getting started</a>
</li>

                        
                            
<li >
    <a href="api/fhir/cds-hooks/">CDS hooks</a>
</li>

                        
                            
<li >
    <a href="api/fhir/hook-catalog/">Hook catalog</a>
</li>

                        
                            
<li >
    <a href="api/fhir/custom-rest/">Custom REST</a>
</li>

                        
                            
<li >
    <a href="api/fhir/resources/">Resources</a>
</li>

                        
                            
<li >
    <a href="api/fhir/code-systems/">Code Systems</a>
</li>

                        
                            
<li >
    <a href="api/fhir/extensions/">Extensions</a>
</li>

                        
                            
<li >
    <a href="api/fhir/oda/">ODA-specific information</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="active">
                        <a href="security/">Security & Error handling</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fa fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="api/fhir/oda/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li class="disabled">
                        <a rel="prev" >
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#security">Security</a></li>
            <li class="second-level"><a href="#network-security">Network security</a></li>
                
                <li class="third-level"><a href="#httphttps">HTTP/HTTPS</a></li>
                <li class="third-level"><a href="#authentication-partially-implemented">Authentication (partially implemented)</a></li>
            <li class="second-level"><a href="#patient-data-security-and-liability">Patient data security and liability</a></li>
                
                <li class="third-level"><a href="#cluster-security">Cluster security</a></li>
                <li class="third-level"><a href="#logging">Logging</a></li>
        <li class="first-level "><a href="#error-handling">Error handling</a></li>
            <li class="second-level"><a href="#error-types">Error types</a></li>
                
            <li class="second-level"><a href="#retrying-requests">Retrying requests</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="security">Security</h1>
<h2 id="network-security">Network security</h2>
<h3 id="httphttps">HTTP/HTTPS</h3>
<p>By default, EBMEDS 2.0 serves its API over HTTP, with no encryption. It is, however, strongly recommended to enable HTTPS or use a reverse proxy like <a href="https://nginx.org/en/">nginx</a> to provide SSL termination. There are two potentially public service that is good to protect: <code>api-gateway</code> and <code>kibana</code>.</p>
<h4 id="enabling-native-https-for-api-gateway">Enabling native HTTPS for <code>api-gateway</code></h4>
<p>HTTPS is enabled by setting the environment variable <code>HTTP_MODE</code> to <code>https</code> when launching the <code>api-gateway</code> container. In addition to this, the system administrator must obtain/generate a .key and .crt file and bind mount them onto the container so they may be read by the <code>api-gateway</code> service.</p>
<p>Inside the container, the path to the aforementioned key and certificate files are by default <code>ssl/server.key</code> and <code>ssl/server.crt</code> but may be configured with the environment variables <code>HTTPS_KEY_PATH</code> and <code>HTTPS_CERT_PATH</code>, respectively. The path can be absolute, or (like in the default case) relative to the execution directory.</p>
<p>As an example, when starting the <code>api-gateway</code> service, it can be done like this:</p>
<pre><code class="bash"># bind mount the .key and .crt files to match the default container-internal ssl/server.* path
docker run -d -it --name api-gateway -e HTTP_MODE=https -v path/to/generated.key:ssl/server.key:ro -v path/to/generated.crt:ssl/server.crt:ro api-gateway:latest
</code></pre>

<p>Note that if <code>api-gateway</code> is clustered onto several nodes, the files must be present on each server, either copied or shared over a network file system.</p>
<h4 id="enabling-native-https-for-kibana">Enabling native HTTPS for <code>kibana</code></h4>
<p>It is not recommended to open up the log viewing UI <code>kibana</code> for public use due to data sensitivity concerns. In any case, however Kibana is run, it is usually a good idea to encrypt the traffic. Kibana is an open source project with flexible configuration options, SSL being one of them. SSL configuration (<a href="https://www.elastic.co/guide/en/kibana/5.6/production.html#enabling-ssl"></a>) is done similarly to <code>api-gateway</code>, i.e. SSL is turned on and .key and .crt files are provided to the service. In this case, it is not done by environment variables but the Kibana configuration file. In the <code>ebmeds-docker</code> package, this is found in <code>kibana/config/kibana.yml</code>.</p>
<h3 id="authentication-partially-implemented">Authentication (partially implemented)</h3>
<p>EBMEDS 2.0 handles authentication by a HTTP bearer token. This token must be included in the header of all requests to the service. EBMEDS can be configured to:</p>
<ol>
<li>Accept all traffic, without a token.</li>
<li>Authenticate traffic using a single, global token.</li>
<li>(<strong>To be implemented</strong>) Authenticate traffic using a multitenancy approach, where each user has his own token. This also enables per-user configuration of the response.</li>
</ol>
<h2 id="patient-data-security-and-liability">Patient data security and liability</h2>
<p>EBMEDS operates with patient data, so data security and anonymity is paramount. EBMEDS has no need for any personally identifying data like names or social security numbers. The only biographical information used is age and gender, which is sent in addition to the clinical data (diagnoses, medication etc.) itself. However, it is up to the users of the EBMEDS service to ensure that no explicitly identifying information is sent to EBMEDS. Duodecim accepts no liability should e.g. social security numbers be present in the request data.</p>
<p>The data security model is simple insofar as EBMEDS is completely stateless. In other words, there is no direct way of connecting the data in a request with any earlier requests. This also means that each request must contain all the data required for that particular CDS context.</p>
<h3 id="cluster-security">Cluster security</h3>
<p>EBMEDS is a microservice architecture, meaning that the EBMEDS service in general consists of smaller services that communicate internally with each other. EBMEDS can be run on a single machine or clustered over multiple servers. The underlying platform is Docker Swarm, which has <a href="https://docs.docker.com/engine/userguide/networking/overlay-security-model/">the following network security model</a>.</p>
<p>In short, if EBMEDS is clustered onto multiple machines, intra-service communication may send patient data "over the wire". This traffic is unencrypted by default. It is up to the system administrator to ensure that communication between cluster nodes is secure, especially if the cluster is located in multiple data centers. Alternatively encryption of the entire Swarm overlay network can be enabled in Docker, although this is bad for performance.</p>
<h3 id="logging">Logging</h3>
<p>The one place where patient data may be stored is the service's logs. EBMEDS internally runs the so-called "ELK stack" (Elasticsearch, Logstash, Kibana). In other words, all logs are stored in an Elasticsearch database. Logging is done in two ways: regular service event logs, and logging of request/response data, i.e. patient data. Again, once the data is logged, it is up to the system administrator to store it and its backups in a secure fashion.</p>
<h4 id="requestresponse-logging">Request/response logging</h4>
<p>EBMEDS may be configured to log the request data, i.e. patient data, together with the resulting response data structure. This is done partially for debugging purposes, partially for liability purposes (if some user requires a certain period of traceability for all decision support requests). The request/response data is also useful for statistical reasons, and some services utilizing this log data has already cropped up.</p>
<p>This type of logging can naturally be turned off completely.</p>
<h4 id="service-event-logging">Service event logging</h4>
<p>Regular "system logs" from the internal microservices, interesting mainly for system administrators and developers. All services use the <a href="https://github.com/trentm/node-bunyan">Bunyan logging library</a> which in turn sends the logs to Logstash, and finally they end up in Elasticsearch. Bunyan, like so many other logging libraries, has the concept of <em>log levels</em>, i.e. the quantified importance of a particular log message. In normal operation, logging is only done on the <code>info</code> log level, meaning that the levels <code>info</code>, <code>warn</code>, <code>error</code>, <code>fatal</code> actually end up in the log database.</p>
<p><strong>NOTE</strong>: If the log level is set lower than <code>info</code>, i.e. if it is set to <code>debug</code> or <code>trace</code>, there may be some logging of patient data, in the form of internal data structures that are displayed in the logs. Do not use these log levels in production, at least not if you want to avoid storing patient data.</p>
<h1 id="error-handling">Error handling</h1>
<p>EBMEDS 2.0 uses standard HTTP error codes in its API. In addition to this, a JSON body is returned with some additional information, if available.</p>
<p>Example:</p>
<pre><code class="json">{
  &quot;statusCode&quot;: 400,
  &quot;message&quot;: &quot;Validation error: QuestionnaireResponse did not validate against Questionnaire: [more info]&quot;,
  &quot;code&quot;: &quot;validation&quot;
}
</code></pre>

<ul>
<li><code>statusCode</code>: The same numerical HTTP error code as in the HTTP headers.</li>
<li><code>message</code>: A human-readable error message.</li>
<li><code>code</code> (<strong>optional</strong>): A short string describing special error types, for errors with a definite meaning to the caller. Is not necessarily present in all error messages. The available types are found below.</li>
</ul>
<h2 id="error-types">Error types</h2>
<p>In addition to the HTTP status code, some errors may have a more specific type attached to it. The current list of types is:</p>
<ul>
<li><code>validation</code>: The user sent a request that failed validation in some way.</li>
<li><code>questionnaire-deprecated</code>: The entire questionnaire has been removed from production and should not be used.</li>
<li><code>questionnaire-version-deprecated</code>: This specific version of the questionnaire has been removed from production, please use a newer version.</li>
</ul>
<h2 id="retrying-requests">Retrying requests</h2>
<p>As a general rule of thumb, 4xx errors require some action on the calling side, while 5xx errors are server-side. For 5xx errors, especially HTTP error 503 (service busy/unavailable), it is prudent to retry the request after a short wait, in case the error is transient in nature.</p></div>
        
    </div>

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
    </footer>

    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '..';
    </script>
    <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
    <script src="../js/base.js"></script>
    <script src="../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
